<!DOCTYPE html>
<html>
<head>
    <title>Force Service Worker Update</title>
</head>
<body>
    <h1>Updating Service Worker...</h1>
    <p id="status">Please wait...</p>

    <script>
        if ('serviceWorker' in navigator) {
            console.log('Unregistering all service workers...');
            document.getElementById('status').textContent = 'Unregistering old service workers...';
            
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                const promises = registrations.map(registration => {
                    console.log('Unregistering:', registration);
                    return registration.unregister();
                });
                
                return Promise.all(promises);
            }).then(() => {
                console.log('All service workers unregistered');
                document.getElementById('status').textContent = 'Clearing caches...';
                
                // 清除所有緩存
                return caches.keys();
            }).then(function(cacheNames) {
                const deletePromises = cacheNames.map(function(cacheName) {
                    console.log('Deleting cache:', cacheName);
                    return caches.delete(cacheName);
                });
                
                return Promise.all(deletePromises);
            }).then(function() {
                console.log('All caches cleared');
                document.getElementById('status').textContent = 'Registering new service worker...';
                
                // 重新註冊 Service Worker
                return navigator.serviceWorker.register('/sw.js');
            }).then(function(registration) {
                console.log('New service worker registered:', registration);
                document.getElementById('status').textContent = 'Service worker updated successfully! Redirecting...';
                
                // 等待新的 Service Worker 激活
                return new Promise((resolve) => {
                    if (registration.active) {
                        resolve();
                    } else {
                        registration.addEventListener('statechange', () => {
                            if (registration.active) {
                                resolve();
                            }
                        });
                    }
                });
            }).then(() => {
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            }).catch(function(error) {
                console.error('Error updating service worker:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
            });
        } else {
            document.getElementById('status').textContent = 'Service Worker not supported';
        }
    </script>
</body>
</html>